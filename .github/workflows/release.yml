name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: 'src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

      - name: Verify and prepare updater assets
        shell: pwsh
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        run: |
          Write-Host "=== Bundle output ==="
          Get-ChildItem -Path "src-tauri\target\release\bundle" -Recurse -File | ForEach-Object {
            Write-Host "$($_.FullName) ($($_.Length) bytes)"
          }
          
          # MSI.zipと.sigがビルドで自動生成されたか確認
          $msiZip = Get-ChildItem -Path "src-tauri\target\release\bundle\msi\*.msi.zip" -ErrorAction SilentlyContinue | Select-Object -First 1
          $msiSig = Get-ChildItem -Path "src-tauri\target\release\bundle\msi\*.msi.zip.sig" -ErrorAction SilentlyContinue | Select-Object -First 1

          if (-not $msiZip -or -not $msiSig) {
            Write-Host "Auto-generated sig not found, signing manually..."
            $msiPath = Get-ChildItem -Path "src-tauri\target\release\bundle\msi\*.msi" | Select-Object -First 1
            if (-not $msiPath) {
              Write-Error "MSI file not found"
              exit 1
            }

            # ZIPファイルを作成（無圧縮=Stored方式を使用、互換性が最も高い）
            $zipPath = "$($msiPath.FullName).zip"
            if (-not (Test-Path $zipPath)) {
              # 無圧縮ZIPを作成（Tauri updaterと互換性あり）
              Add-Type -AssemblyName System.IO.Compression.FileSystem
              Add-Type -AssemblyName System.IO.Compression
              
              $zip = [System.IO.Compression.ZipFile]::Open($zipPath, [System.IO.Compression.ZipArchiveMode]::Create)
              # NoCompressionを使用（互換性が最も高い）
              $compressionLevel = [System.IO.Compression.CompressionLevel]::NoCompression
              [System.IO.Compression.ZipFileExtensions]::CreateEntryFromFile($zip, $msiPath.FullName, $msiPath.Name, $compressionLevel)
              $zip.Dispose()
              
              Write-Host "Created ZIP (uncompressed): $zipPath"
            }

            # 署名を生成（--private-keyには鍵の内容を渡す）
            npx tauri signer sign "$zipPath" --private-key "$env:TAURI_SIGNING_PRIVATE_KEY"

            if (Test-Path "$zipPath.sig") {
              Write-Host "Successfully created signature: $zipPath.sig"
            } else {
              Write-Error "Failed to create signature file"
              exit 1
            }
            
            $msiZip = Get-Item $zipPath
            $msiSig = Get-Item "$zipPath.sig"
          } else {
            Write-Host "Signatures auto-generated by Tauri build"
          }

          # latest.json を生成
          $version = "${{ github.ref_name }}".TrimStart('v')
          $signature = Get-Content $msiSig.FullName -Raw

          # GitHub releases uses dots instead of spaces in filename
          $actualFileName = $msiZip.Name -replace ' ','.'

          # CHANGELOGからリリースバージョンのセクションを抽出する関数
          function Extract-VersionSection {
            param([string]$FilePath, [string]$Version)
            if (-not (Test-Path $FilePath)) { return "" }
            $content = Get-Content $FilePath -Raw -Encoding UTF8
            # ## [X.Y.Z] - YYYY-MM-DD のパターンでセクションを抽出
            $escapedVersion = [regex]::Escape($Version)
            $pattern = "(?ms)^## \[$escapedVersion\].*?$\r?\n(.*?)(?=^## \[|\z)"
            if ($content -match $pattern) {
              return $Matches[1].Trim()
            }
            return ""
          }

          $notesJa = Extract-VersionSection -FilePath "CHANGELOG_ja.md" -Version $version
          $notesEn = Extract-VersionSection -FilePath "CHANGELOG.md" -Version $version

          Write-Host "=== Changelog (ja) ==="
          Write-Host $notesJa
          Write-Host "=== Changelog (en) ==="
          Write-Host $notesEn

          # notes フィールドに多言語 JSON を埋め込み
          $notesObj = @{ ja = $notesJa; en = $notesEn }
          $notesJson = $notesObj | ConvertTo-Json -Compress

          $json = @{
            version = $version
            notes = $notesJson
            pub_date = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
            platforms = @{
              "windows-x86_64" = @{
                signature = $signature.Trim()
                url = "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/$actualFileName"
              }
            }
          } | ConvertTo-Json -Depth 10

          $json | Out-File -FilePath "latest.json" -Encoding utf8 -NoNewline
          Write-Host "Generated latest.json"
          Write-Host $json

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          name: 'YouTube Local Viewer ${{ github.ref_name }}'
          body: |
            YouTube Local Viewer ${{ github.ref_name }} をリリースしました。 / YouTube Local Viewer ${{ github.ref_name }} has been released.

            ## インストール方法 / Installation

            ### 初回インストール / First-time Install
            - **推奨 / Recommended**: `YouTube.Local.Viewer_1.0.0_x64-setup.exe` (NSIS)
            - または / Or: `YouTube.Local.Viewer_1.0.0_x64_en-US.msi`

            管理者権限不要で、初回起動時にyt-dlp/ffmpegの自動ダウンロードが案内されます。
            No admin privileges required. On first launch, you will be guided through automatic download of yt-dlp and ffmpeg.

            ## アップデート機能 / Auto-Update
            - 起動時に自動的に最新バージョンをチェック / Automatically checks for new versions on startup
            - ワンクリックで更新可能 / One-click update available
            - MSIファイルは自動更新で使用されます / MSI files are used for auto-updates

            ## 注意事項 / Notes
            - Windows 10/11 64bit対応 / Supports Windows 10/11 64-bit
            - 未署名のため、SmartScreenの警告が表示される場合があります / The app is unsigned, so you may see a SmartScreen warning
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/msi/*.msi.zip
            src-tauri/target/release/bundle/msi/*.msi.zip.sig
            src-tauri/target/release/bundle/nsis/*.exe
            latest.json
