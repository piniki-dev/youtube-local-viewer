name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: 'src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Decode signing key
        id: decode-key
        shell: pwsh
        env:
          TAURI_PRIVATE_KEY_BASE64: ${{ secrets.TAURI_PRIVATE_KEY }}
        run: |
          # GitHub Secretsに保存したBase64エンコード済み秘密鍵をデコード
          $keyBytes = [Convert]::FromBase64String($env:TAURI_PRIVATE_KEY_BASE64)
          $keyContent = [System.Text.Encoding]::UTF8.GetString($keyBytes)
          Write-Host "Decoded private key, lines: $($keyContent.Split("`n").Length), size: $($keyBytes.Length) bytes"
          # GITHUB_ENVに書き込み（改行対応のためdelimiter方式）
          $delimiter = "EOF_$(Get-Random)"
          "TAURI_SIGNING_PRIVATE_KEY<<$delimiter" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          $keyContent | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8 -NoNewline
          "`n$delimiter" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Build Tauri app
        run: npm run tauri build
        env:
          TAURI_KEY_PASSWORD: ""

      - name: Verify and prepare updater assets
        shell: pwsh
        run: |
          Write-Host "=== Bundle output ==="
          Get-ChildItem -Path "src-tauri\target\release\bundle" -Recurse -File | ForEach-Object {
            Write-Host "$($_.FullName) ($($_.Length) bytes)"
          }
          
          # MSI.zipと.sigがビルドで自動生成されたか確認
          $msiZip = Get-ChildItem -Path "src-tauri\target\release\bundle\msi\*.msi.zip" -ErrorAction SilentlyContinue | Select-Object -First 1
          $msiSig = Get-ChildItem -Path "src-tauri\target\release\bundle\msi\*.msi.zip.sig" -ErrorAction SilentlyContinue | Select-Object -First 1

          if (-not $msiZip -or -not $msiSig) {
            Write-Host "Auto-generated sig not found, signing manually..."
            $msiPath = Get-ChildItem -Path "src-tauri\target\release\bundle\msi\*.msi" | Select-Object -First 1
            if (-not $msiPath) {
              Write-Error "MSI file not found"
              exit 1
            }

            # ZIPファイルを作成
            $zipPath = "$($msiPath.FullName).zip"
            if (-not (Test-Path $zipPath)) {
              Compress-Archive -Path $msiPath.FullName -DestinationPath $zipPath -Force
              Write-Host "Created ZIP: $zipPath"
            }

            # 署名を生成（--private-keyには鍵の内容を渡す）
            npx tauri signer sign "$zipPath" --private-key "$env:TAURI_SIGNING_PRIVATE_KEY"

            if (Test-Path "$zipPath.sig") {
              Write-Host "Successfully created signature: $zipPath.sig"
            } else {
              Write-Error "Failed to create signature file"
              exit 1
            }
            
            $msiZip = Get-Item $zipPath
            $msiSig = Get-Item "$zipPath.sig"
          } else {
            Write-Host "Signatures auto-generated by Tauri build"
          }

          # latest.json を生成
          $version = "${{ github.ref_name }}".TrimStart('v')
          $signature = Get-Content $msiSig.FullName -Raw

          $json = @{
            version = $version
            notes = "See release notes for details"
            pub_date = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
            platforms = @{
              "windows-x86_64" = @{
                signature = $signature.Trim()
                url = "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/$($msiZip.Name)"
              }
            }
          } | ConvertTo-Json -Depth 10

          $json | Out-File -FilePath "latest.json" -Encoding utf8 -NoNewline
          Write-Host "Generated latest.json"
          Write-Host $json

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          name: 'YouTube Local Viewer ${{ github.ref_name }}'
          body: |
            YouTube Local Viewer ${{ github.ref_name }} をリリースしました。

            ## インストール方法
            
            ### 初回インストール
            - **推奨**: `YouTube.Local.Viewer_x.x.x_x64-setup.exe` (NSIS)
            - または: `YouTube.Local.Viewer_x.x.x_x64_en-US.msi`
            
            管理者権限不要で、初回起動時にyt-dlp/ffmpegの自動ダウンロードが案内されます。

            ## アップデート機能
            - 起動時に自動的に最新バージョンをチェック
            - ワンクリックで更新可能
            - MSIファイルは自動更新で使用されます

            ## 注意事項
            - Windows 10/11 64bit対応
            - 未署名のため、SmartScreenの警告が表示される場合があります
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/msi/*.msi.zip
            src-tauri/target/release/bundle/msi/*.msi.zip.sig
            src-tauri/target/release/bundle/nsis/*.exe
            latest.json
